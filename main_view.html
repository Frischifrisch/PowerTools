<html>
    <head>
        <link rel="stylesheet" href="/steam_resource/css/2.css">
        <link rel="stylesheet" href="/steam_resource/css/39.css">
        <link rel="stylesheet" href="/steam_resource/css/library.css">
        <script src="/static/library.js"></script>
        <script>
            // Python functions
            function setCPUs(value, smt) {
                return call_plugin_method("set_cpus", {"count":value, "smt": smt});
            }
            
            function getCPUs() {
                return call_plugin_method("get_cpus", {});
            }

            function getSMT() {
                return call_plugin_method("get_smt", {});
            }
            
            function setCPUBoost(value) {
                return call_plugin_method("set_boost", {"enabled": value});
            }
            
            function getCPUBoost() {
                return call_plugin_method("get_boost", {});
            }

            function setMaxBoost(index) {
                return call_plugin_method("set_max_boost", {"index": index});
            }

            function getMaxBoost() {
                return call_plugin_method("get_max_boost", {});
            }

            function setFanTick(tick) {
                return call_plugin_method("set_fan_tick", {"tick": tick});
            }

            function getFanTick() {
                return call_plugin_method("get_fan_tick", {});
            }
            
            // other logic
            
            async function onReady() {
                let boostToggle = document.getElementById("boostToggle");
                setToggleState(boostToggle, await getCPUBoost());
                setToggleState(document.getElementById("smtToggle"), await getSMT());
                selectNotch("cpuThreadsNotch", await getCPUs() - 1, 8);
                selectNotch("frequencyNotch", await getMaxBoost(), 3);
                selectNotch("fanNotch", await getFanTick(), 7);
            }

            async function setCPUNotch(index) {
                const ROOT_ID = "cpuThreadsNotch";
                await setCPUs(index, getToggleState(document.getElementById("smtToggle")));
                selectNotch(ROOT_ID, await getCPUs() - 1, 8);
            }
            
            function setToggleState(toggle, state) {
                const ENABLED_CLASS = "gamepaddialog_On_yLrDA";
                if (state && !toggle.classList.contains(ENABLED_CLASS)) {
                    toggle.classList.add(ENABLED_CLASS);
                }

                if (!state && toggle.classList.contains(ENABLED_CLASS)) {
                    toggle.classList.remove(ENABLED_CLASS);
                }
            }
            
            function getToggleState(toggle) {
                return toggle.classList.contains("gamepaddialog_On_yLrDA");
            }
            
            async function toggleCPUBoost() {
                let toggle = document.getElementById("boostToggle");
                let isActive = getToggleState(toggle);
                await setCPUBoost(!isActive);
                setToggleState(toggle, !isActive);
            }

            async function toggleCPUSMT() {
                let toggle = document.getElementById("smtToggle");
                let isActive = getToggleState(toggle);
                let currentCPUs = await getCPUs();
                if (currentCPUs == 4 && !isActive) {
                    // if all cores are running, enable all the threads as well
                    await setCPUs(8, !isActive);
                } else {
                    await setCPUs(currentCPUs, !isActive);
                }

                setToggleState(toggle, !isActive);
                selectNotch("cpuThreadsNotch", await getCPUs() - 1, 8);
            }

            async function setBoostNotch(index) {
                const ROOT_ID = "frequencyNotch";
                await setMaxBoost(index);
                selectNotch(ROOT_ID, await getMaxBoost(), 3);
            }

            async function onSetFanNotch(index) {
                const ROOT_ID = "fanNotch";
                await setFanTick(index);
                selectNotch(ROOT_ID, index, 7);
            }

            function selectNotch(rootId, index, elements) {
                // WARNING: this yeets any style in div of slider
                const ENABLED_CLASS = "gamepadslider_TickActive_j418S";
                //console.log("Selecting notches up to " + index);
                let root = document.getElementById(rootId);
                root.style = "--normalized-slider-value:" + index/(elements-1) + ";";
                for (let i = 0; i < elements; i++) {
                    let notch = document.getElementById(rootId + i);
                    if (notch.classList.contains(ENABLED_CLASS) && i > index) {
                        notch.classList.remove(ENABLED_CLASS);
                    } else if (!notch.classList.contains(ENABLED_CLASS) && i <= index) {
                        notch.classList.add(ENABLED_CLASS);
                    }
                }
            }
            
        </script>
        <style type="text/css" media="screen"></style>
    </head>
    <body onload="onReady()">
        <!-- SMT toggle switch, roughly copied from https://github.com/SteamDeckHomebrew/ExtraSettingsPlugin/blob/main/main_view.html -->
        <!-- Due to a bug in MangoHud, this has been hidden for now -->
        <div class="quickaccessmenu_TabGroupPanel_1QO7b Panel Focusable" style="display:none;">
            <div class="quickaccesscontrols_PanelSectionRow_26R5w">
                <div class="quickaccesscontrols_PanelSectionRow_26R5w">
                    <div class="gamepaddialog_Field_eKmEX gamepaddialog_WithFirstRow_2bDqk gamepaddialog_ExtraPaddingOnChildrenBelow_3nLNL gamepaddialog_StandardPadding_xIITX gamepaddialog_HighlightOnFocus_2HFrm Panel Focusable" style="--indent-level:0;">
                        <div class="gamepaddialog_FieldLabelRow_2VcTl">
                            <div class="gamepaddialog_FieldLabel_3jMlJ">
                                CPU SMT
                            </div>
                            <div class="gamepaddialog_FieldChildren_2rhav">
                                <div id="smtToggle" tabindex="0" class="gamepaddialog_Toggle_9Ql-o Focusable" onclick="toggleCPUSMT()">
                                    <div class="gamepaddialog_ToggleRail_2bl0i"></div>
                                    <div class="gamepaddialog_ToggleSwitch_1PQpp"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- CPUs selector -->
        <div class="gamepaddialog_Field_eKmEX gamepaddialog_WithFirstRow_2bDqk gamepaddialog_WithChildrenBelow_37xzV gamepaddialog_InlineWrapShiftsChildrenBelow_3LCXh gamepaddialog_WithBottomSeparator_3YKpU gamepaddialog_ChildrenWidthFixed_ljcbL gamepaddialog_ExtraPaddingOnChildrenBelow_3nLNL gamepaddialog_StandardPadding_xIITX gamepaddialog_HighlightOnFocus_2HFrm Panel Focusable">
            <div class="gamepaddialog_FieldLabelRow_2VcTl">
                <div class="gamepaddialog_FieldLabel_3jMlJ">Threads</div>
            </div>
            <div id="cpuThreadsNotch" class="gamepadslider_SliderControlAndNotches_23hjX Focusable" tabindex="0" style="--normalized-slider-value:0.5;">
                <div class="gamepadslider_SliderControl_1udlG">
                    <div class="gamepadslider_SliderTrack_2_vG6 gamepadslider_SliderHasNotches_1Lr71 "></div>
                    <div class="gamepadslider_SliderHandleContainer_8xNY6">
                        <div class="gamepadslider_SliderHandle_11PBf"></div>
                    </div>
                </div>
                <div class="gamepadslider_SliderNotchContainer_2yM7S Panel Focusable">
                    <div class="gamepadslider_SliderNotch_LYPXt">
                        <div id="cpuThreadsNotch0" class="gamepadslider_SliderNotchTick_u8QEa" onclick='setCPUNotch(1)'></div>
                        <div class="gamepadslider_SliderNotchLabel_dbACW">1</div>
                    </div>
                    <div class="gamepadslider_SliderNotch_LYPXt">
                        <div id="cpuThreadsNotch1" class="gamepadslider_SliderNotchTick_u8QEa" onclick='setCPUNotch(2)'></div>
                        <div class="gamepadslider_SliderNotchLabel_dbACW">2</div>
                    </div>
                    <div class="gamepadslider_SliderNotch_LYPXt">
                        <div id="cpuThreadsNotch2" class="gamepadslider_SliderNotchTick_u8QEa" onclick='setCPUNotch(3)'></div>
                        <div class="gamepadslider_SliderNotchLabel_dbACW">3</div>
                    </div>
                    <div class="gamepadslider_SliderNotch_LYPXt">
                        <div id="cpuThreadsNotch3" class="gamepadslider_SliderNotchTick_u8QEa" onclick='setCPUNotch(4)'></div>
                        <div class="gamepadslider_SliderNotchLabel_dbACW">4</div>
                    </div>
                    <div class="gamepadslider_SliderNotch_LYPXt">
                        <div id="cpuThreadsNotch4" class="gamepadslider_SliderNotchTick_u8QEa" onclick='setCPUNotch(5)'></div>
                        <div class="gamepadslider_SliderNotchLabel_dbACW">5</div>
                    </div>
                    <div class="gamepadslider_SliderNotch_LYPXt">
                        <div id="cpuThreadsNotch5" class="gamepadslider_SliderNotchTick_u8QEa" onclick='setCPUNotch(6)'></div>
                        <div class="gamepadslider_SliderNotchLabel_dbACW">6</div>
                    </div>
                    <div class="gamepadslider_SliderNotch_LYPXt">
                        <div id="cpuThreadsNotch6" class="gamepadslider_SliderNotchTick_u8QEa" onclick='setCPUNotch(7)'></div>
                        <div class="gamepadslider_SliderNotchLabel_dbACW">7</div>
                    </div>
                    <div class="gamepadslider_SliderNotch_LYPXt">
                        <div id="cpuThreadsNotch7" class="gamepadslider_SliderNotchTick_u8QEa" onclick='setCPUNotch(8)'></div>
                        <div class="gamepadslider_SliderNotchLabel_dbACW">8</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CPU Boost toggle switch, roughly copied from https://github.com/SteamDeckHomebrew/ExtraSettingsPlugin/blob/main/main_view.html -->
        <div class="quickaccessmenu_TabGroupPanel_1QO7b Panel Focusable">
            <div class="quickaccesscontrols_PanelSectionRow_26R5w">
                <div class="quickaccesscontrols_PanelSectionRow_26R5w">
                    <div class="gamepaddialog_Field_eKmEX gamepaddialog_WithFirstRow_2bDqk gamepaddialog_ExtraPaddingOnChildrenBelow_3nLNL gamepaddialog_StandardPadding_xIITX gamepaddialog_HighlightOnFocus_2HFrm Panel Focusable" style="--indent-level:0;">
                        <div class="gamepaddialog_FieldLabelRow_2VcTl">
                            <div class="gamepaddialog_FieldLabel_3jMlJ">
                                CPU Boost
                            </div>
                            <div class="gamepaddialog_FieldChildren_2rhav">
                                <div id="boostToggle" tabindex="0" class="gamepaddialog_Toggle_9Ql-o Focusable" onclick="toggleCPUBoost()">
                                    <div class="gamepaddialog_ToggleRail_2bl0i"></div>
                                    <div class="gamepaddialog_ToggleSwitch_1PQpp"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Frequency selector -->
        <div class="gamepaddialog_Field_eKmEX gamepaddialog_WithFirstRow_2bDqk gamepaddialog_WithChildrenBelow_37xzV gamepaddialog_InlineWrapShiftsChildrenBelow_3LCXh gamepaddialog_WithBottomSeparator_3YKpU gamepaddialog_ChildrenWidthFixed_ljcbL gamepaddialog_ExtraPaddingOnChildrenBelow_3nLNL gamepaddialog_StandardPadding_xIITX gamepaddialog_HighlightOnFocus_2HFrm Panel Focusable">
            <div class="gamepaddialog_FieldLabelRow_2VcTl">
                <div class="gamepaddialog_FieldLabel_3jMlJ">Max Frequency</div>
            </div>
            <div class="gamepaddialog_FieldChildren_2rhav">
            <div id="frequencyNotch" class="gamepadslider_SliderControlAndNotches_23hjX Focusable" tabindex="0" style="--normalized-slider-value:0.5;">
                <div class="gamepadslider_SliderControl_1udlG">
                    <div class="gamepadslider_SliderTrack_2_vG6 gamepadslider_SliderHasNotches_1Lr71 "></div>
                    <div class="gamepadslider_SliderHandleContainer_8xNY6">
                        <div class="gamepadslider_SliderHandle_11PBf"></div>
                    </div>
                </div>
                <div class="gamepadslider_SliderNotchContainer_2yM7S Panel Focusable">
                    <div class="gamepadslider_SliderNotch_LYPXt">
                        <div id="frequencyNotch0" class="gamepadslider_SliderNotchTick_u8QEa gamepadslider_TickActive_j418S" onclick='setBoostNotch(0)'></div>
                        <div class="gamepadslider_SliderNotchLabel_dbACW" style="margin-left:2em;">1.7GHz</div>
                    </div>
                    <div class="gamepadslider_SliderNotch_LYPXt">
                        <div id="frequencyNotch1" class="gamepadslider_SliderNotchTick_u8QEa gamepadslider_TickActive_j418S" onclick='setBoostNotch(1)'></div>
                        <div class="gamepadslider_SliderNotchLabel_dbACW">2.4GHz</div>
                    </div>
                    <div class="gamepadslider_SliderNotch_LYPXt">
                        <div id="frequencyNotch2" class="gamepadslider_SliderNotchTick_u8QEa" onclick='setBoostNotch(2)'></div>
                        <div class="gamepadslider_SliderNotchLabel_dbACW" style="margin-right:2em;">2.8GHz</div>
                    </div>
                </div>
            </div>
            </div>
            <div style="font-size:x-small;">
            WARNING: This will change the CPU governor.
            </div>
        </div>

        <!-- Fan voltage selector -->
        <div class="gamepaddialog_Field_eKmEX gamepaddialog_WithFirstRow_2bDqk gamepaddialog_WithChildrenBelow_37xzV gamepaddialog_InlineWrapShiftsChildrenBelow_3LCXh gamepaddialog_WithBottomSeparator_3YKpU gamepaddialog_ChildrenWidthFixed_ljcbL gamepaddialog_ExtraPaddingOnChildrenBelow_3nLNL gamepaddialog_StandardPadding_xIITX gamepaddialog_HighlightOnFocus_2HFrm Panel Focusable">
            <div class="gamepaddialog_FieldLabelRow_2VcTl">
                <div class="gamepaddialog_FieldLabel_3jMlJ">Fan Voltage</div>
            </div>
            <div class="gamepaddialog_FieldChildren_2rhav">
            <div id="fanNotch" class="gamepadslider_SliderControlAndNotches_23hjX Focusable" tabindex="0" style="--normalized-slider-value:0.33;">
                <div class="gamepadslider_SliderControl_1udlG">
                    <div class="gamepadslider_SliderTrack_2_vG6 gamepadslider_SliderHasNotches_1Lr71 "></div>
                    <div class="gamepadslider_SliderHandleContainer_8xNY6">
                        <div class="gamepadslider_SliderHandle_11PBf"></div>
                    </div>
                </div>
                <div class="gamepadslider_SliderNotchContainer_2yM7S Panel Focusable">
                    <div class="gamepadslider_SliderNotch_LYPXt">
                        <div id="fanNotch0" class="gamepadslider_SliderNotchTick_u8QEa gamepadslider_TickActive_j418S" onclick='onSetFanNotch(0)'></div>
                        <div class="gamepadslider_SliderNotchLabel_dbACW">0V</div>
                    </div>
                    <div class="gamepadslider_SliderNotch_LYPXt">
                        <div id="fanNotch1" class="gamepadslider_SliderNotchTick_u8QEa gamepadslider_TickActive_j418S" onclick='onSetFanNotch(1)'></div>
                        <div class="gamepadslider_SliderNotchLabel_dbACW">1V</div>
                    </div>
                    <div class="gamepadslider_SliderNotch_LYPXt">
                        <div id="fanNotch2" class="gamepadslider_SliderNotchTick_u8QEa gamepadslider_TickActive_j418S" onclick='onSetFanNotch(2)'></div>
                        <div class="gamepadslider_SliderNotchLabel_dbACW">2V</div>
                    </div>
                    <div class="gamepadslider_SliderNotch_LYPXt">
                        <div id="fanNotch3" class="gamepadslider_SliderNotchTick_u8QEa gamepadslider_TickActive_j418S" onclick='onSetFanNotch(3)'></div>
                        <div class="gamepadslider_SliderNotchLabel_dbACW">3V</div>
                    </div>
                    <div class="gamepadslider_SliderNotch_LYPXt">
                        <div id="fanNotch4" class="gamepadslider_SliderNotchTick_u8QEa gamepadslider_TickActive_j418S" onclick='onSetFanNotch(4)'></div>
                        <div class="gamepadslider_SliderNotchLabel_dbACW">4V</div>
                    </div>
                    <div class="gamepadslider_SliderNotch_LYPXt">
                        <div id="fanNotch5" class="gamepadslider_SliderNotchTick_u8QEa gamepadslider_TickActive_j418S" onclick='onSetFanNotch(5)'></div>
                        <div class="gamepadslider_SliderNotchLabel_dbACW">5V</div>
                    </div>
                    <div class="gamepadslider_SliderNotch_LYPXt">
                        <div id="fanNotch6" class="gamepadslider_SliderNotchTick_u8QEa gamepadslider_TickActive_j418S" onclick='onSetFanNotch(6)'></div>
                        <div class="gamepadslider_SliderNotchLabel_dbACW">Auto</div>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </body>
</html>
